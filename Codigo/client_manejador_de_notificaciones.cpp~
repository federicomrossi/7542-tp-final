//
//  client_manejador_de_notificaciones.cpp
//  CLASE MANEJADORDENOTIFICACIONES
//  


#include "client_manejador_de_notificaciones.h"




/* ****************************************************************************
 * DEFINICIÃ“N DE LA CLASE
 * ***************************************************************************/


// Constructor
ManejadorDeNotificaciones::ManejadorDeNotificaciones(Receptor *receptor,
	Sincronizador *sincronizador, ReceptorDeArchivos *receptorDeArchivos) :
	receptor(receptor), sincronizador(sincronizador), 
	receptorDeArchivos(receptorDeArchivos) { }


// Destructor
ManejadorDeNotificaciones::~ManejadorDeNotificaciones() { }


// Define tareas a ejecutar en el hilo.
// Routea las notifiaciones y mensajes de entrada
void ManejadorDeNotificaciones::run() {
	std::string mensaje;
	while (this->isActive()) {
		// Pide un mensaje de la cola al receptor
		mensaje = this->receptor->obtenerMensajeDeEntrada();

		// Formato de notificacion: "<'n'><Instruccion><Arg1-Arg2-Arg3..>"
		if (mensaje[0] == 'n')  { // Es una notificacion
			mensaje.erase(0,1);  // Se borra el identificador

			//DEBUG
			std::cout << "Es notificacion" << std::endl;
			//FIN DEBUG

			this->sincronizador->recibirNotificacion(mensaje);
		}
		// Formato de archivo: "<'f'><Accion><Arg1-Arg2-Arg3..>"
		// Donde 'Accion' es 'ADD' para agregar o 'DEL' para eliminar archivo
		// del directorio local
		else {
			if (mensaje[0] == 'f') {  // Es un archivo
				mensaje.erase(0,1);  // Se borra el identificador

				//DEBUG
				std::cout << "Es archivo" << std::endl;
				//FIN DEBUG

				this->receptorDeArchivos->recibirArchivo(mensaje);
			}
			else  // Con cualquier otro mensaje, frena
				this->stop();  
		}
		mensaje.clear();
	}
}

